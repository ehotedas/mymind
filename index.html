<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mymind</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Playfair+Display:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-1:#0f1226;
      --bg-2:#1a1f3d;
      --acc-1:#8fd3fe;
      --acc-2:#c3f7c6;
      --paper:#fffdfa;
      --ink:#1c2330;
      --shadow: 0 6px 22px rgba(10,14,35,.28), 0 2px 10px rgba(10,14,35,.18);
    }
    *{ box-sizing:border-box }
    html,body{ height:100%; margin:0 }
    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:#e9ecf1;
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(143,211,254,.13), transparent 60%),
        radial-gradient(1000px 700px at 85% 90%, rgba(195,247,198,.12), transparent 60%),
        linear-gradient(135deg, var(--bg-1), var(--bg-2));
      overflow:hidden;
    }

    .topbar{
      position:fixed; inset:18px auto auto 18px; z-index:2000;
      display:flex; gap:12px; align-items:center;
      background: transparent; border:none; border-radius:16px; padding:12px 14px; box-shadow:none;
    }
    .brand{font-weight:800; letter-spacing:.3px; font-size:14px; opacity:.95}
    .brand .my{color:#ffffff}
    .brand .mind{color:var(--acc-1)}

    .composer{ display:flex; align-items:center; gap:10px; flex-wrap:wrap }
    .add-trigger{
      padding:12px 14px; border-radius:12px;
      border:none; background:transparent; color:#dce3ee;
      cursor:text; user-select:none;
    }
    .composer input[type="text"]{
      display:none; width: clamp(220px, 30vw, 440px);
      padding: 12px 14px; border-radius: 12px;
      border:1px solid rgba(255,255,255,.22);
      background: transparent; color:#eef1f7; outline:none;
    }
    .composer input::placeholder{ color:#c9cfda; opacity:.66 }
    .composer.active .add-trigger{ display:none }
    .composer.active input[type="text"]{ display:block }

    .stage{ position:relative; width:100%; height:100%; overflow:hidden }

    .note{
      position:absolute; min-width:180px; max-width:clamp(280px,28vw,360px); padding:18px 18px 28px;
      background: var(--paper); color: var(--ink);
      border-radius:18px; box-shadow:var(--shadow);
      user-select:none; will-change:transform,left,top;
      transform: translateZ(0);
      animation: float var(--dur,10s) ease-in-out var(--delay,0s) infinite alternate;
      animation-play-state: paused;
      opacity: 0;
      transform-origin:50% 50%;
      transition: opacity .35s ease;
      cursor:grab;
      transform: translate(var(--x0,0), var(--y0,0)) rotate(var(--r0,0deg));
    }
    .note.live{ animation-play-state: running; opacity: 1; }
    .note.dragging{ cursor:grabbing; animation-play-state:paused; z-index:3000; }
    .note.pinned{ animation-play-state: paused !important; z-index: 2500; }

    .note-toolbar{ position:absolute; top:6px; right:6px; display:flex; align-items:center; }
    .gear{ appearance:none; border:0; background:transparent; padding:0; margin:0; font-size:16px; cursor:pointer; line-height:1 }

    /* MENU AJUSTES */
    .menu{
      position:absolute; right:0; bottom:38px;
      display:none; flex-direction:column; align-items:stretch;
      gap:6px; padding:8px;
      background:#ffffff; border:1px solid rgba(0,0,0,.1);
      border-radius:12px; box-shadow:0 8px 18px rgba(0,0,0,.18);
      min-width:160px; overflow:hidden;
    }
    .menu.open{ display:flex }
    .menu .item{
      display:flex; align-items:center; justify-content:center;
      width:100%; box-sizing:border-box;
      padding:8px 10px;
      border:1px solid rgba(0,0,0,.08);
      background:#f5f6f8;
      border-radius:10px;
      font-size:12px; font-weight:600; color:#1f2937;
      cursor:pointer; text-align:center; white-space:nowrap;
    }
    .menu .item:hover{ background:#eef1ff }

    @keyframes float{
      0%{transform:translate(var(--x0,0),var(--y0,0)) rotate(var(--r0,-.8deg));}
      50%{transform:translate(var(--x1,8px),var(--y1,-8px)) rotate(var(--r1,.8deg));}
      100%{transform:translate(var(--x2,-6px),var(--y2,6px)) rotate(var(--r2,0deg));}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand"><span class="my">My</span><span class="mind">mind</span></div>
    <form class="composer" id="composer" autocomplete="off">
      <span id="addTrigger" class="add-trigger">Adicionar...</span>
      <input id="textInput" type="text" maxlength="220" placeholder="Escreva e tecle Enter‚Ä¶" />
    </form>
  </div>

  <div class="stage" id="stage"></div>

  <script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js";

  // üîπ Cole aqui os dados do seu Supabase
  const SUPABASE_URL  = "https://rfygkxjvzlsqdudydydf.supabase.co"; // Project URL
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJmeWdreGp2emxzcWR1ZHlkeWRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMzk0NzksImV4cCI6MjA3MTkxNTQ3OX0.OdyKdmbEUHDcBtUzXqzz2inDAeQN2Sd9RiZGgkXKcCk";           // anon public key
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

  // ====== SELETORES ORIGINAIS ======
  const stage = document.getElementById('stage');
  const form  = document.getElementById('composer');
  const input = document.getElementById('textInput');
  const addTrigger = document.getElementById('addTrigger');

  // ====== ESTADO LOCAL (apenas posi√ß√£o/cor/fixar) ======
  const STATE_KEY = 'mymind_state';
  const rand = (a,b)=>Math.random()*(b-a)+a;
  const clamp = (v,a,b)=>Math.min(Math.max(v,a),b);
  const loadState = ()=>{ try{ return JSON.parse(localStorage.getItem(STATE_KEY)||'{}'); }catch{ return {}; } };
  const saveState = (obj)=>localStorage.setItem(STATE_KEY, JSON.stringify(obj));
  const state = loadState(); // { "<texto>": {x,y,bg,fg,pin} }

  function persistCard(el, text){
    state[text] = {
      x: parseFloat(el.style.left)||0,
      y: parseFloat(el.style.top)||0,
      bg: el.style.background || undefined,
      fg: el.style.color || undefined,
      pin: el.classList.contains('pinned') || undefined
    };
    saveState(state);
  }

  function startLive(el, i=0){
    requestAnimationFrame(()=>requestAnimationFrame(()=>{
      setTimeout(()=> el.classList.add('live'), i * 60);
    }));
  }

  function createNote(text){
    const s = state[text] || {};
    const el = document.createElement('article');
    el.className = 'note';

    const amp = () => (Math.random() < 0.5 ? -1 : 1) * rand(2, 10);
    const rot = () => (Math.random() < 0.5 ? -1 : 1) * rand(0.2, 1.2);
    el.style.setProperty('--x0', `${amp()}px`);
    el.style.setProperty('--y0', `${amp()}px`);
    el.style.setProperty('--x1', `${amp()}px`);
    el.style.setProperty('--y1', `${amp()}px`);
    el.style.setProperty('--x2', `${amp()}px`);
    el.style.setProperty('--y2', `${amp()}px`);
    el.style.setProperty('--r0', `${rot()}deg`);
    el.style.setProperty('--r1', `${rot()}deg`);
    el.style.setProperty('--r2', `0deg`);
    el.style.setProperty('--dur', `${rand(8, 14)}s`);
    el.style.setProperty('--delay', `${rand(0, 2)}s`);

    el.style.transform = 'translate(var(--x0), var(--y0)) rotate(var(--r0))';

    el.innerHTML = `
      <p></p>
      <div class="note-toolbar">
        <button class="gear" title="Ajustes" aria-haspopup="menu">‚öôÔ∏è</button>
        <div class="menu" role="menu" aria-label="Ajustes">
          <button class="item item-fixar" data-action="fixar" role="menuitem">FIXAR</button>
          <button class="item" data-target="bg" role="menuitem">FUNDO</button>
          <button class="item" data-target="fg" role="menuitem">FONTE</button>
        </div>
        <input type="color" class="picker bgPicker" hidden>
        <input type="color" class="picker fgPicker" hidden>
      </div>`;

    el.querySelector('p').textContent = text;

    const initX = (typeof s.x==='number') ? s.x : rand(40, Math.max(44, window.innerWidth  - 360));
    const initY = (typeof s.y==='number') ? s.y : rand(40, Math.max(44, window.innerHeight - 220));
    el.style.left = initX + 'px';
    el.style.top  = initY + 'px';

    if(s.bg) el.style.background = s.bg;
    if(s.fg) el.style.color      = s.fg;
    if(s.pin) el.classList.add('pinned');

    const gear     = el.querySelector('.gear');
    const menu     = el.querySelector('.menu');
    const fixBtn   = el.querySelector('.item-fixar');
    const bgPicker = el.querySelector('.bgPicker');
    const fgPicker = el.querySelector('.fgPicker');

    bgPicker.value = s.bg || '#fffdfa';
    fgPicker.value = s.fg || '#1c2330';

    function updateFixLabel(){
      fixBtn.textContent = el.classList.contains('pinned') ? 'DESFIXAR' : 'FIXAR';
    }
    function toggleFix(){
      el.classList.toggle('pinned');
      updateFixLabel();
      persistCard(el, text);
    }
    updateFixLabel();

    gear.addEventListener('click', (e)=>{ e.stopPropagation(); menu.classList.toggle('open'); });
    document.addEventListener('click', (e)=>{ if(!el.contains(e.target)) menu.classList.remove('open'); });

    menu.addEventListener('click', (e)=>{
      const btn = e.target.closest('.item'); if(!btn) return;
      const act = btn.dataset.action;
      const tgt = btn.dataset.target;
      if(act === 'fixar'){ toggleFix(); }
      if(tgt === 'bg'){ bgPicker.click(); }
      if(tgt === 'fg'){ fgPicker.click(); }
    });

    bgPicker.addEventListener('input', (e)=>{ el.style.background = e.target.value; persistCard(el, text); });
    fgPicker.addEventListener('input', (e)=>{ el.style.color      = e.target.value; persistCard(el, text); });

    let sx=0, sy=0, ox=0, oy=0;
    function onDown(ev){
      if(ev.button!==undefined && ev.button!==0) return;
      el.classList.add('dragging');
      sx = ev.clientX; sy = ev.clientY; ox = parseFloat(el.style.left)||0; oy = parseFloat(el.style.top)||0;
      window.addEventListener('pointermove', onMove);
      window.addEventListener('pointerup',   onUp, { once:true });
    }
    function onMove(ev){
      const dx = ev.clientX - sx; const dy = ev.clientY - sy;
      const nx = clamp(ox + dx, 0, window.innerWidth  - el.offsetWidth);
      const ny = clamp(oy + dy, 0, window.innerHeight - el.offsetHeight);
      el.style.left = nx + 'px'; el.style.top  = ny + 'px';
    }
    function onUp(){ el.classList.remove('dragging'); window.removeEventListener('pointermove', onMove); persistCard(el, text); }
    el.addEventListener('pointerdown', onDown);

    el.addEventListener('dblclick', ()=>{ el.remove(); persistCard(el, text); });

    return el;
  }

  // ====== SUPABASE: CARREGAR ======
  async function fetchMessages(){
    const { data, error } = await supabase
      .from('messages')
      .select('messages, created_at')
      .order('created_at', { ascending:false })
      .limit(200);
    if(error){ console.error(error); return []; }
    return data || [];
  }

  async function render(){
    stage.innerHTML='';
    const rows = await fetchMessages();
    const frag = document.createDocumentFragment();
    const elements = rows.map(r => createNote(r.messages));
    elements.forEach(el => frag.appendChild(el));
    stage.appendChild(frag);
    elements.forEach((el, i)=> startLive(el, i));
  }

  // ====== UI: ABRIR COMPOSER ======
  addTrigger.addEventListener('click', ()=>{
    form.classList.add('active');
    input.value = '';
    input.focus();
  });

  // ====== SUPABASE: ENVIAR ======
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const messages = input.value.trim(); if(!messages) return;
    const { error } = await supabase.from('messages').insert({ messages });
    if(error){ alert('Erro ao enviar'); console.error(error); return; }
    input.value='';
    form.classList.remove('active');
    // n√£o renderiza tudo de novo ‚Äî o Realtime abaixo insere a nova nota
  });

  // ====== SUPABASE: REALTIME ======
  supabase.channel('realtime:messages')
    .on('postgres_changes', { event:'INSERT', schema:'public', table:'messages' }, (payload)=>{
      const text = payload.new.messages;
      const el = createNote(text);
      stage.prepend(el);
      startLive(el, 0);
    })
    .subscribe();

  // ====== PRIMEIRA RENDERIZA√á√ÉO ======
  render();

  // ====== AJUSTE AO REDIMENSIONAR ======
  window.addEventListener('resize', ()=>{
    document.querySelectorAll('.note').forEach(n=>{
      const nx = Math.min(parseFloat(n.style.left)||0, Math.max(0, window.innerWidth  - n.offsetWidth));
      const ny = Math.min(parseFloat(n.style.top) ||0, Math.max(0, window.innerHeight - n.offsetHeight));
      n.style.left = nx + 'px'; n.style.top = ny + 'px';
    });
    saveState(state);
  });
  </script>
</body>
</html>
